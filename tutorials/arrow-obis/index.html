<!DOCTYPE html>
<html lang='en' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='Working with large datasets can be hard due to memory constraints, but using Parquet files can make it possible.'>
<meta name='theme-color' content='#0076b1'>

<meta property='og:title' content='Using the Parquet format with OBIS data • Silas Principe'>
<meta property='og:description' content='Working with large datasets can be hard due to memory constraints, but using Parquet files can make it possible.'>
<meta property='og:url' content='http://www.example.com/tutorials/arrow-obis/'>
<meta property='og:site_name' content='resources'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/4c5a7ea9f5ed13b0617b0aa63f544caf?s=256'><meta property='article:section' content='tutorials'><meta property='article:tag' content='r'><meta property='article:tag' content='parquet'><meta property='article:published_time' content='2023-08-01T00:00:00Z'/><meta property='article:modified_time' content='2023-08-01T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:creator' content='@silasprincipe'>

<meta name="generator" content="Hugo 0.88.1" />

  <title>Using the Parquet format with OBIS data • Silas Principe</title>
  <link rel='canonical' href='http://www.example.com/tutorials/arrow-obis/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#0076b1;}
</style>

  

</head>
<body class='page type-tutorials has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      resources
      </a>
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/packages/'>Packages</a></li><li class='item has-current'>
  <a href='/tutorials/'>Tutorials</a></li><li class='item'>
  <a href='https://manual.obis.org/'>OBIS Manual &#8599;</a></li><li class='item'>
  <a href='https://github.com/iobis/resources'>Repo &#8599;</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/parquet/' style='font-size:1em'>parquet</a>
      </li><li>
        <a href='/tags/r/' style='font-size:1em'>r</a>
      </li></ul>
</div>


</section>
<section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/MunifTanjim' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/MunifTanjim' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:contact@example.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/muniftanjim' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section></div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button><div class='header-widgets'>
        <div class='container'></div>
      </div><header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'>
              <p class='site-title title'>resources</p>
            <p class='desc site-desc'></p>
          </div>
        </div>
      </header><main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Using the Parquet format with OBIS data</h1>
      
<p class='desc'>Working with large datasets can be hard due to memory constraints, but using Parquet files can make it possible.</p>


    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2023-08-01T00:00:00Z'>2023, Aug 01</time>
</span>

  <span class='byline'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/silasprincipe'>Silas Principe</a></span>
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
6 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <h1 id="what-is-parquet">What is Parquet?</h1>
<p>Parquet is a lightweight format designed for columnar storage. Its main
difference when compared to other formats like <strong>csv</strong> is that Parquet
is column-oriented (while csv is row-oriented). This means that Parquet
is much more efficient for data accessing.To illustrate, consider the
scenario of extracting data from a specific column in a CSV file. This
operation entails reading through all rows across all columns. In
contrast, Parquet enables selective access solely to the required
column, minimizing unnecessary data retrieval. Also very important:
Parquet files are several times lighter than csv files, improving
storage and sharing of data. You can learn more about Parquet
<a href="https://parquet.apache.org/">here</a>.</p>
<!-- raw HTML omitted -->
<p>The <code>Arrow</code> package enable to work with Parquet files (as well some
other interesting formats) within R. You can read the full documentation
of the package <a href="https://arrow.apache.org/docs/r/index.html">here</a>.</p>
<p>We will now see how you can use Parquet in your data analysis workflow.
Note that the real advantage of Parquet comes when working with large
datasets, specially those that you can’t load into memory.</p>
<h1 id="reading-and-writing-parquet-files">Reading and writing Parquet files</h1>
<p>Opening a Parquet file is similar to opening a csv, and is done through
the function <code>read_parquet</code>. We will start working with a small dataset
containing records from <strong>OBIS</strong> for a fiddler crab species (<em>Leptuca
thayeri</em>) which you can download
<a href="https://raw.githubusercontent.com/iobis/resources/main/content/tutorials/arrow-obis/leptuca_thayeri.parquet">here</a>.</p>
<pre><code>library(arrow) # To open the parquet files
library(dplyr) # For data manipulation

species &lt;- read_parquet(&quot;leptuca_thayeri.parquet&quot;)

head(species)

## # A tibble: 6 × 127
##   basisOfRecord     class       continent country countryCode county datasetName
##   &lt;chr&gt;             &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt;  &lt;chr&gt;      
## 1 HumanObservation  Malacostra… América … Colomb… CO          San A… Epifauna m…
## 2 HumanObservation  Malacostra… América … Colomb… CO          San A… Epifauna m…
## 3 PreservedSpecimen Malacostra… &lt;NA&gt;      Brazil  &lt;NA&gt;        Paran… &lt;NA&gt;       
## 4 HumanObservation  Malacostra… América … Colomb… CO          San A… Epifauna m…
## 5 HumanObservation  Malacostra… América … Colomb… CO          San A… Epifauna m…
## 6 HumanObservation  Malacostra… América … Colomb… CO          San A… Epifauna m…
## # ℹ 120 more variables: dateIdentified &lt;chr&gt;, day &lt;chr&gt;, decimalLatitude &lt;dbl&gt;,
## #   decimalLongitude &lt;dbl&gt;, establishmentMeans &lt;chr&gt;, eventDate &lt;chr&gt;,
## #   eventID &lt;chr&gt;, family &lt;chr&gt;, genus &lt;chr&gt;, geodeticDatum &lt;chr&gt;,
## #   georeferenceVerificationStatus &lt;chr&gt;, georeferencedBy &lt;chr&gt;,
## #   georeferencedDate &lt;chr&gt;, habitat &lt;chr&gt;, higherClassification &lt;chr&gt;,
## #   identifiedBy &lt;chr&gt;, identifiedByID &lt;chr&gt;, institutionCode &lt;chr&gt;,
## #   institutionID &lt;chr&gt;, kingdom &lt;chr&gt;, language &lt;chr&gt;, locality &lt;chr&gt;, …
</code></pre>
<p>As you can see, the returned object is a <code>tibble</code> and you can work with
it as any other regular data frame. So, for example, to get all records
from Brazil, we can simply use this:</p>
<pre><code>species_br &lt;- species %&gt;%
  filter(country == &quot;Brazil&quot;)

head(species_br, 2)

## # A tibble: 2 × 127
##   basisOfRecord     class       continent country countryCode county datasetName
##   &lt;chr&gt;             &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt;  &lt;chr&gt;      
## 1 PreservedSpecimen Malacostra… &lt;NA&gt;      Brazil  &lt;NA&gt;        Paran… &lt;NA&gt;       
## 2 PreservedSpecimen Malacostra… &lt;NA&gt;      Brazil  &lt;NA&gt;        Mucuri &lt;NA&gt;       
## # ℹ 120 more variables: dateIdentified &lt;chr&gt;, day &lt;chr&gt;, decimalLatitude &lt;dbl&gt;,
## #   decimalLongitude &lt;dbl&gt;, establishmentMeans &lt;chr&gt;, eventDate &lt;chr&gt;,
## #   eventID &lt;chr&gt;, family &lt;chr&gt;, genus &lt;chr&gt;, geodeticDatum &lt;chr&gt;,
## #   georeferenceVerificationStatus &lt;chr&gt;, georeferencedBy &lt;chr&gt;,
## #   georeferencedDate &lt;chr&gt;, habitat &lt;chr&gt;, higherClassification &lt;chr&gt;,
## #   identifiedBy &lt;chr&gt;, identifiedByID &lt;chr&gt;, institutionCode &lt;chr&gt;,
## #   institutionID &lt;chr&gt;, kingdom &lt;chr&gt;, language &lt;chr&gt;, locality &lt;chr&gt;, …
</code></pre>
<p>Saving a data frame to Parquet is also simple, and is done through the
<code>write_parquet</code> function:</p>
<pre><code>write_parquet(species_br, &quot;leptuca_thayeri_br.parquet&quot;)
</code></pre>
<h1 id="opening-larger-than-memory-files">Opening larger-than-memory files</h1>
<p>While using Parquet files for smaller datasets is also relevant
(remember: it’s several times lighter!), the real power of Parquet (and
<code>Arrow</code>) is the ability to work with large datasets without the need to
load all the data to memory. Suppose you want to get the number of
records available on OBIS for each Teleostei species. This would involve
loading all the OBIS database in the memory before filtering the data.
If you ever tried that, it’s quite probable that your R crashed.
However, with Arrow this is a straightforward task.</p>
<p>For this part of the tutorial, we will work with the full export of the
OBIS database which you can download here:
<a href="https://obis.org/data/access/">https://obis.org/data/access/</a>. The file have ~15GB.</p>
<pre><code>obis_file &lt;- &quot;obis_20230726.parquet&quot; # The path to the file
</code></pre>
<p>This time, instead of using <code>read_parquet</code> we will use the function
<code>open_dataset</code>. The function will not read all the file into memory, but
will instead read a “schema” showing how the file is organized.</p>
<pre><code>obis &lt;- open_dataset(obis_file)
</code></pre>
<p>If you print the <code>obis</code> object you will see that it is not a data frame,
but instead a <code>FileSytemDataset</code> object, showing the columns of the
table with their respective data types. So how can we access the data?
<code>Arrow</code> support <code>dplyr</code> verbs that enable us to work with the data
without loading it. So in our case we can filter the data as usual:</p>
<pre><code>teleostei &lt;- obis %&gt;%
  filter(class == &quot;Teleostei&quot;) %&gt;%
  filter(taxonRank == &quot;Species&quot;) %&gt;%
  group_by(species) %&gt;%
  summarise(records = n()) %&gt;%
  collect()

head(teleostei)

## # A tibble: 6 × 2
##   species                 records
##   &lt;chr&gt;                     &lt;int&gt;
## 1 Sebastes maliger          41380
## 2 Pycnochromis acares        8724
## 3 Gymnothorax fimbriatus      857
## 4 Monotaxis grandoculis     10961
## 5 Ctenochaetus flavicauda    1297
## 6 Sargocentron tiere         3687
</code></pre>
<p>Depending on the filters it may take a few seconds before the data is
returned. Note that after all the filters we added <code>collect()</code>, what
indicates to <code>Arrow</code> that it should process our request. Several <code>dplyr</code>
verbs are available to use with <code>Arrow</code>, a full list can be found
<a href="https://arrow.apache.org/docs/dev/r/reference/acero.html">here</a>.</p>
<p>When working with large datasets, it’s important that your filter
produces an object of reasonable size (i.e., that after <code>collect()</code> can
be loaded in memory).</p>
<p>If you need to inspect the data before filtering, its possible to load
only a slice of the data with <code>slice_head</code>:</p>
<pre><code>obis %&gt;%
  select(class, taxonRank, species) %&gt;% # Select just a few columns
  slice_head(n = 5) %&gt;% # Select the first 5 lines
  collect() # Process the request

## # A tibble: 5 × 3
##   class     taxonRank species               
##   &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;                 
## 1 Teleostei Species   Sebastes maliger      
## 2 Teleostei Species   Pycnochromis acares   
## 3 Teleostei Species   Pycnochromis acares   
## 4 Teleostei Species   Pycnochromis acares   
## 5 Teleostei Species   Gymnothorax fimbriatus
</code></pre>
<h1 id="learning-more">Learning more</h1>
<p>This tutorial barely scratches the surface of the full potential of
working with Parquet. For example, it’s possible to save Parquet
datasets in a way that only certain parts of the data need to be read,
what can improve even more the computation. The better place to learn
more about <code>Arrow</code> is the package website which contain several useful
articles - <a href="https://arrow.apache.org/docs/dev/r/index.html">https://arrow.apache.org/docs/dev/r/index.html</a></p>
<p>You can also see this tutorial on using Parquet with GBIF data:
<a href="https://data-blog.gbif.org/post/apache-arrow-and-parquet/">https://data-blog.gbif.org/post/apache-arrow-and-parquet/</a></p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/tutorial/'>tutorial</a>, <a class='category' href='/categories/r/'>r</a>, <a class='category' href='/categories/data-manipulation/'>data-manipulation</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/r/'>r</a>, <a class='tag' href='/tags/parquet/'>parquet</a></div>

  </div>
</footer>


</article>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2023 Ocean Biodiversity Information System (OBIS) </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script><script src='/js/custom.js'></script>

</body>

</html>

