<!DOCTYPE html>
<html lang='en' dir='auto'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='OBIS now has a full export in GeoParquet format, but to work with large datasets you need the right tools. Here we explore how you can use DuckDB to (very) fastly retrieve data from this resource.'>
<meta name='theme-color' content='#0076b1'>

<meta property='og:title' content='Using DuckDB to query the OBIS full export - Part 2 (spatial extension) • Silas Principe'>
<meta property='og:description' content='OBIS now has a full export in GeoParquet format, but to work with large datasets you need the right tools. Here we explore how you can use DuckDB to (very) fastly retrieve data from this resource.'>
<meta property='og:url' content='http://www.example.com/tutorials/duckdb-part2/'>
<meta property='og:site_name' content='resources'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/4c5a7ea9f5ed13b0617b0aa63f544caf?s=256'><meta property='article:section' content='tutorials'><meta property='article:tag' content='r'><meta property='article:tag' content='obis'><meta property='article:tag' content='parquet'><meta property='article:tag' content='duckdb'><meta property='article:tag' content='spatial'><meta property='article:published_time' content='2025-09-26T00:00:00Z'/><meta property='article:modified_time' content='2025-09-26T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:creator' content='@silasprincipe'>

<meta name="generator" content="Hugo 0.88.1" />

  <title>Using DuckDB to query the OBIS full export - Part 2 (spatial extension) • Silas Principe</title>
  <link rel='canonical' href='http://www.example.com/tutorials/duckdb-part2/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.ab98e12b.css'><link rel='stylesheet' href='/css/custom.css'><style>
:root{--color-accent:#0076b1;}
</style>

  

</head>
<body class='page type-tutorials has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <div class='logo'>
      <a href='/'>
        <img src='/images/logo.png'>
      </a>
    </div>
    
    <h2 class='title site-title '>
      <a href='/'>
      resources
      </a>
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-sidebar_menu sep-after'><nav id='sidebar-menu' class='menu sidebar-menu' aria-label='Sidebar Menu'>
    <div class='container'>
      <ul><li class='item'>
  <a href='/'>Home</a></li><li class='item'>
  <a href='/packages/'>Packages</a></li><li class='item has-current'>
  <a href='/tutorials/'>Tutorials</a></li><li class='item'>
  <a href='/find-your-dwc/'>Find your DwC</a></li><li class='item'>
  <a href='https://manual.obis.org/'>OBIS Manual &#8599;</a></li><li class='item'>
  <a href='https://github.com/iobis/resources'>Repo &#8599;</a></li></ul>
    </div>
  </nav>

</section><section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud'><li>
        <a href='/tags/duckdb/' style='font-size:1.3333333333333333em'>duckdb</a>
      </li><li>
        <a href='/tags/obis/' style='font-size:1.6666666666666665em'>obis</a>
      </li><li>
        <a href='/tags/parquet/' style='font-size:1.6666666666666665em'>parquet</a>
      </li><li>
        <a href='/tags/r/' style='font-size:2em'>r</a>
      </li><li>
        <a href='/tags/spatial/' style='font-size:1em'>spatial</a>
      </li></ul>
</div>


</section>
<section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/MunifTanjim' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/MunifTanjim' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:contact@example.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/muniftanjim' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section></div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button><div class='header-widgets'>
        <div class='container'></div>
      </div><header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'>
              <p class='site-title title'>resources</p>
            <p class='desc site-desc'></p>
          </div>
        </div>
      </header><main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>Using DuckDB to query the OBIS full export - Part 2 (spatial extension)</h1>
      
<p class='desc'>OBIS now has a full export in GeoParquet format, but to work with large datasets you need the right tools. Here we explore how you can use DuckDB to (very) fastly retrieve data from this resource.</p>


    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2025-09-26T00:00:00Z'>2025, Sep 26</time>
</span>

  <span class='byline'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M21,21V20c0-2.76-4-5-9-5s-9,2.24-9,5v1"/>
  <path d="M16,6.37A4,4,0,1,1,12.63,3,4,4,0,0,1,16,6.37Z"/>
  
</svg>
<span class='screen-reader-text'> by </span><a href='/authors/silasprincipe'>Silas Principe</a></span>
  
<span class='reading-time'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <circle cx="12" cy="12" r="10"/>
  <polyline points="12 6 12 12 15 15"/>
  
</svg>
5 mins read
</span>


</div>


  </div>
</header>

  
  

  <div class='container entry-content'>
  <h1 id="spatial-extension-of-duckdb">Spatial extension of DuckDB</h1>
<p>In a <a href="http://www.example.com/tutorials/duckdb-part1/">previous tutorial</a> we learned about <strong>DuckDB</strong> and how it can be used to query Parquet datasets from OBIS. As we shared, the new full export is a <a href="https://geoparquet.org/">GeoParquet</a> dataset, meaning that it add spatial functionalities to the standard Parquet format. DuckDB has a powerful spatial extension, which we will present in this tutorial. Of course, we will just give you a glimpse of what you can do with this extension, and you should invest a few minutes to explore the <a href="https://duckdb.org/docs/stable/core_extensions/spatial/overview.html">full documentation</a>.</p>
<p>Again, we will work with a local copy of the full export, which you can download from here: <a href="https://obis.org/data/access/">https://obis.org/data/access/</a>. You can also explore together through the Jupyter Notebook (<a href="https://github.com/iobis/resources/blob/main/content/tutorials/duckdb-part2/duckdb-part2.ipynb">download it locally</a> or open it through <strong>Google Colab</strong> by <a href="https://colab.research.google.com/github/iobis/resources/blob/main/content/tutorials/duckdb-part2/duckdb-part2.ipynb">clicking here</a>).</p>
<p>We will get all records for the sea-urchin <a href="https://obis.org/taxon/124316"><em>Paracentrotus lividus</em></a> and the macroalgae <a href="https://obis.org/taxon/145728"><em>Laminaria ochroleuca</em></a> on a region in the coast of Portugal and Spain. We will use a WKT (Well-Known Text) representation of a polygon:</p>
<p><code>POLYGON ((-12.436523 35.817813, -3.999023 35.817813, -3.999023 44.465151, -12.436523 44.465151, -12.436523 35.817813))</code></p>
<p>You can check it on this nice website: <a href="https://wktmap.com/">https://wktmap.com/</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">suppressPackageStartupMessages</span>(<span style="color:#a6e22e">library</span>(dplyr)) <span style="color:#75715e"># For some analysis</span>
<span style="color:#a6e22e">suppressPackageStartupMessages</span>(<span style="color:#a6e22e">library</span>(duckdb)) <span style="color:#75715e"># Our main package</span>
<span style="color:#a6e22e">suppressPackageStartupMessages</span>(<span style="color:#a6e22e">library</span>(tictoc)) <span style="color:#75715e"># To get timings</span>
<span style="color:#a6e22e">suppressPackageStartupMessages</span>(<span style="color:#a6e22e">library</span>(glue)) <span style="color:#75715e"># To easily make the queries text</span>
<span style="color:#a6e22e">suppressPackageStartupMessages</span>(<span style="color:#a6e22e">library</span>(sf)) <span style="color:#75715e"># To later work with the spatial results</span>
<span style="color:#a6e22e">suppressPackageStartupMessages</span>(<span style="color:#a6e22e">library</span>(ggplot2)) <span style="color:#75715e"># For plotting</span>

<span style="color:#75715e"># To work with DuckDB, we need to start by oppening a</span>
<span style="color:#75715e"># connection to an in-memory database, using the DBI package</span>
con <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbConnect</span>(<span style="color:#a6e22e">duckdb</span>())

<span style="color:#75715e"># Install the httpfs extension</span>
<span style="color:#a6e22e">dbSendQuery</span>(con, <span style="color:#e6db74">&#34;install spatial; load spatial;&#34;</span>)

<span style="color:#75715e"># Put here the path to your downloaded full export</span>
full_export <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;/Volumes/OBIS2/obis_20250318_parquet/occurrence&#34;</span>

<span style="color:#75715e"># Region:</span>
my_wkt <span style="color:#f92672">&lt;-</span> <span style="color:#e6db74">&#34;POLYGON ((-12.436523 35.817813, -3.999023 35.817813, -3.999023 44.465151, -12.436523 44.465151, -12.436523 35.817813))&#34;</span>

species_id <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">124316</span>, <span style="color:#ae81ff">145728</span>)

<span style="color:#75715e"># DuckDB query</span>
<span style="color:#a6e22e">tic</span>(<span style="color:#e6db74">&#34;DuckDB query on full export with spatial extension&#34;</span>)
species_records <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbGetQuery</span>(con, <span style="color:#a6e22e">glue</span>(
    <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    SELECT AphiaID, scientificName, date_year, occurrenceID, ST_AsText(geometry) AS geometry
</span><span style="color:#e6db74">    FROM read_parquet(&#39;{full_export}/*.parquet&#39;)
</span><span style="color:#e6db74">    WHERE
</span><span style="color:#e6db74">        AphiaID IN ({paste(species_id, collapse = &#39;, &#39;)}) AND
</span><span style="color:#e6db74">        -- ST_Intersects and ST_geometry are functions from the spatial extension
</span><span style="color:#e6db74">        ST_Intersects (geometry, ST_GeomFromText(&#39;{my_wkt}&#39;));
</span><span style="color:#e6db74">    &#34;</span>
))
<span style="color:#a6e22e">toc</span>()
</code></pre></div><pre><code>DuckDB query on full export with spatial extension: 15.106 sec elapsed
</code></pre>
<p>And this is the resulting table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">head</span>(species_records, <span style="color:#ae81ff">3</span>)
</code></pre></div><pre><code>  aphiaid       scientificName date_year
1  145728 Laminaria ochroleuca      2018
2  145728 Laminaria ochroleuca      1992
3  145728 Laminaria ochroleuca      1992
                                                                                        occurrenceID
1 ARMS_Vigo_TorallaA_20180607_20180924_SF40_ETOH_r1:ASV_758:0083628b0f91a654091f79a82b51df876aee08bc
2                                                                                IHCantabria_Preop_9
3                                                                              IHCantabria_Preop_112
                          geometry
1          POINT (-8.7787 42.2284)
2 POINT (-5.988330714 43.58276275)
3      POINT (-5.681897 43.545396)
</code></pre>
<p>As you see, it contains a column <code>geometry</code> which is now converted to a WKT representation of the geometry. We can read it on R by using the <code>sf</code> package. Then we will plot it using <code>ggplot2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sp_records_sf <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_as_sf</span>(species_records, wkt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;geometry&#34;</span>, crs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EPSG:4326&#34;</span>)

<span style="color:#75715e"># To add some context...</span>
selected_area <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_as_sf</span>(<span style="color:#a6e22e">st_as_sfc</span>(my_wkt, crs <span style="color:#f92672">=</span> <span style="color:#ae81ff">4326</span>))
world <span style="color:#f92672">&lt;-</span> rnaturalearth<span style="color:#f92672">::</span><span style="color:#a6e22e">ne_countries</span>(returnclass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sf&#34;</span>)
<span style="color:#a6e22e">sf_use_s2</span>(<span style="color:#66d9ef">FALSE</span>)
</code></pre></div><pre><code>Spherical geometry (s2) switched off
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">world <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">suppressMessages</span>(<span style="color:#a6e22e">suppressWarnings</span>(<span style="color:#a6e22e">st_crop</span>(world, selected_area)))

<span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> world, fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey90&#34;</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> sp_records_sf, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> scientificName), alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">.5</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> selected_area, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">NA</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">theme_light</span>()
</code></pre></div><p><!-- raw HTML omitted --></p>
<p><img src="figure1.png" alt=""></p>
<p>Now, let&rsquo;s consider a buffer around the selected area:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># DuckDB query</span>
<span style="color:#a6e22e">tic</span>(<span style="color:#e6db74">&#34;Buffer query&#34;</span>)
species_records_buff <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbGetQuery</span>(con, <span style="color:#a6e22e">glue</span>(
    <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    SELECT AphiaID, scientificName, date_year, occurrenceID, ST_AsText(geometry) AS geometry
</span><span style="color:#e6db74">    FROM read_parquet(&#39;{full_export}/*.parquet&#39;)
</span><span style="color:#e6db74">    WHERE
</span><span style="color:#e6db74">        AphiaID IN ({paste(species_id, collapse = &#39;, &#39;)}) AND
</span><span style="color:#e6db74">        -- ST_Intersects and ST_geometry are functions from the spatial extension
</span><span style="color:#e6db74">        ST_Intersects (geometry, ST_Buffer(ST_GeomFromText(&#39;{my_wkt}&#39;), 10));
</span><span style="color:#e6db74">        -- The distance of the buffer is expressed in degrees, that is, on the same unit of the CRS of the polygon
</span><span style="color:#e6db74">    &#34;</span>
))
<span style="color:#a6e22e">toc</span>()
</code></pre></div><pre><code>Buffer query: 15.209 sec elapsed
</code></pre>
<p>And this is the resulting table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">head</span>(species_records_buff, <span style="color:#ae81ff">3</span>)
</code></pre></div><pre><code>  aphiaid       scientificName date_year
1  145728 Laminaria ochroleuca      2018
2  145728 Laminaria ochroleuca      1951
3  145728 Laminaria ochroleuca      1998
                                                                                        occurrenceID
1 ARMS_Vigo_TorallaA_20180607_20180924_SF40_ETOH_r1:ASV_758:0083628b0f91a654091f79a82b51df876aee08bc
2                                                                     DASSH_NATENG000001_SE04_145728
3                                                         DASSH_NATENG000087_DK16_2_15_021098_145728
                      geometry
1      POINT (-8.7787 42.2284)
2  POINT (-3.776326 50.228351)
3 POINT (-4.1360712 50.338249)
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sp_records_buff_sf <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_as_sf</span>(species_records_buff, wkt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;geometry&#34;</span>, crs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EPSG:4326&#34;</span>)

selected_area_buff <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">suppressMessages</span>(<span style="color:#a6e22e">suppressWarnings</span>(<span style="color:#a6e22e">st_buffer</span>(selected_area, dist <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>)))

world <span style="color:#f92672">&lt;-</span> rnaturalearth<span style="color:#f92672">::</span><span style="color:#a6e22e">ne_countries</span>(returnclass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sf&#34;</span>)
world <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">suppressMessages</span>(<span style="color:#a6e22e">suppressWarnings</span>(<span style="color:#a6e22e">st_crop</span>(world, selected_area_buff)))

<span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> world, fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey90&#34;</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> sp_records_buff_sf, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> scientificName), alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">.5</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> selected_area, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">NA</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> selected_area_buff, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>, fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">NA</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">theme_light</span>()
</code></pre></div><p><!-- raw HTML omitted --></p>
<p><img src="figure2.png" alt=""></p>
<p>Finally, let&rsquo;s get the convex hull over all records of each species. I will also retrieve all records, so I can plot together. Now that I&rsquo;m doing my last query, I will also close the connection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># DuckDB query</span>
<span style="color:#a6e22e">tic</span>(<span style="color:#e6db74">&#34;Convex hull query&#34;</span>)
species_records_hull <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbGetQuery</span>(con, <span style="color:#a6e22e">glue</span>(
    <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    SELECT 
</span><span style="color:#e6db74">        AphiaID,
</span><span style="color:#e6db74">        scientificName,
</span><span style="color:#e6db74">        ST_AsText(ST_ConvexHull(ST_Union_Agg(geometry))) AS convex_hull
</span><span style="color:#e6db74">    FROM read_parquet(&#39;{full_export}/*.parquet&#39;)
</span><span style="color:#e6db74">    WHERE
</span><span style="color:#e6db74">        AphiaID IN ({paste(species_id, collapse = &#39;, &#39;)})
</span><span style="color:#e6db74">    GROUP BY AphiaID, scientificName
</span><span style="color:#e6db74">    &#34;</span>
))
<span style="color:#a6e22e">toc</span>()
</code></pre></div><pre><code>Convex hull query: 2.101 sec elapsed
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">tic</span>(<span style="color:#e6db74">&#34;All records query&#34;</span>)
species_records_all <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dbGetQuery</span>(con, <span style="color:#a6e22e">glue</span>(
    <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">    SELECT 
</span><span style="color:#e6db74">        AphiaID,
</span><span style="color:#e6db74">        scientificName,
</span><span style="color:#e6db74">        ST_AsText(geometry) AS geometry
</span><span style="color:#e6db74">    FROM read_parquet(&#39;{full_export}/*.parquet&#39;)
</span><span style="color:#e6db74">    WHERE
</span><span style="color:#e6db74">        AphiaID IN ({paste(species_id, collapse = &#39;, &#39;)})
</span><span style="color:#e6db74">    &#34;</span>
))
<span style="color:#a6e22e">toc</span>()
</code></pre></div><pre><code>All records query: 1.995 sec elapsed
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">dbDisconnect</span>(con)
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sp_hull <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_as_sf</span>(species_records_hull, wkt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;convex_hull&#34;</span>, crs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EPSG:4326&#34;</span>)
species_records_all <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">st_as_sf</span>(species_records_all, wkt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;geometry&#34;</span>, crs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;EPSG:4326&#34;</span>)

world <span style="color:#f92672">&lt;-</span> rnaturalearth<span style="color:#f92672">::</span><span style="color:#a6e22e">ne_countries</span>(returnclass <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;sf&#34;</span>)
world <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">suppressMessages</span>(<span style="color:#a6e22e">suppressWarnings</span>(<span style="color:#a6e22e">st_crop</span>(world, sp_hull)))

<span style="color:#a6e22e">ggplot</span>() <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> world, fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey90&#34;</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> sp_hull, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> scientificName), fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">NA</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">geom_sf</span>(data <span style="color:#f92672">=</span> species_records_all, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> scientificName), fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">NA</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">theme_light</span>()
</code></pre></div><p><!-- raw HTML omitted --></p>
<p><img src="figure3.png" alt=""></p>
<p>That is it, now you can work with the spatial extension of DuckDB! In the <a href="http://www.example.com/tutorials/duckdb-part3/">next tutorial</a> we will explore the R package <a href="https://duckplyr.tidyverse.org/index.html"><code>duckplyr</code></a>, a drop-in replacement for DuckDB on R which uses the <code>tidyverse</code> grammar.</p>
<h2 id="bonus-the-duckdb-ui">Bonus: the DuckDB UI</h2>
<p>DuckDB also has a UI extension, which enables you to explore the data using a dashboard-like interface. You can check how it works <a href="https://duckdb.org/2025/03/12/duckdb-ui.html">here</a>.</p>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/tutorial/'>tutorial</a>, <a class='category' href='/categories/r/'>r</a>, <a class='category' href='/categories/data-manipulation/'>data-manipulation</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/r/'>r</a>, <a class='tag' href='/tags/obis/'>obis</a>, <a class='tag' href='/tags/parquet/'>parquet</a>, <a class='tag' href='/tags/duckdb/'>duckdb</a>, <a class='tag' href='/tags/spatial/'>spatial</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/tutorials/duckdb-part3/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Using DuckDB to query the OBIS full export - Part 3 (`duckplyr` package)</a>
    </div><div class='next-entry sep-before'>
      <a href='/tutorials/duckdb-part1/'>
        <span class='screen-reader-text'>Next post: </span>Using DuckDB to query the OBIS full export - Part 1<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>




      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><div class='copyright'>
  <p> &copy; 2023-2025 Ocean Biodiversity Information System (OBIS) </p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.c3bcf2df.js'></script><script src='/js/custom.js'></script>

</body>

</html>

